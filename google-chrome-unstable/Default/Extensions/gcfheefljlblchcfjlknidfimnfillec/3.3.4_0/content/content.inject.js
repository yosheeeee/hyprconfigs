var E=Object.defineProperty;var d=(s,n,t)=>n in s?E(s,n,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[n]=t;var a=(s,n,t)=>(d(s,typeof n!="symbol"?n+"":n,t),t);import{f as r}from"../common/vendor.js";import{c as l}from"../common/logger.js";const e=window.externalAPI;class u{constructor(){a(this,"logger",l("YandexContentScript","info"));this.subscribeForContentScriptCommands(),this.yandexExternalAPISubscribe(),this.getTheme(),this.addFocusEvents()}addFocusEvents(){window.addEventListener("focus",()=>{this.sendOutgoingEvent({type:"EVENT_FOCUS"})}),window.addEventListener("blur",()=>{this.sendOutgoingEvent({type:"EVENT_BLUR"})})}sendOutgoingEvent({type:n,payload:t}){document.dispatchEvent(new CustomEvent("extension.outgoing.event",{detail:{type:n,payload:t}}))}subscribeForContentScriptCommands(){document.addEventListener("extension.incoming.event",({detail:{type:n,payload:t}})=>{switch(this.logger.debug("[subscribeForContentScriptCommands] got extension.incoming.event",n,t),n){case"CS_PLAY":e.togglePause();break;case"CS_POSITION":e.setPosition(t);break;case"CS_URL":e.navigate(t);break;case"CS_SHUFFLE":e.toggleShuffle();break;case"CS_REPEAT":e.toggleRepeat();break;case"CS_NEXT":e.next();break;case"CS_PREV":e.prev();break;case"CS_LIKE":e.toggleLike();break;case"CS_DISLIKE":e.toggleDislike();break;case"CS_VOLUME_UP":e.setVolume(e.getVolume()+.03);break;case"CS_VOLUME_DOWN":e.setVolume(e.getVolume()-.03);break;case"CS_SEEK_FWD":e.setPosition(e.getProgress().position+10);break;case"CS_SEEK_BACK":e.setPosition(e.getProgress().position-10);break;case"CS_VOLUME_TOGGLE":e.toggleMute();break;case"CS_VOLUME":e.setVolume(t);break;case"@@SYNC_RECONNECT_MUTATION":this.sendOutgoingEvent({type:"EVENT_STATE",payload:{isPlaying:e.isPlaying()}}),this.sendOutgoingEvent({type:"EVENT_TRACK",payload:{track:e.getCurrentTrack()}}),this.sendOutgoingEvent({type:"EVENT_PROGRESS",payload:{progress:e.getProgress()}}),this.sendOutgoingEvent({type:"EVENT_CONTROLS",payload:{states:e.getControls(),shuffle:e.getShuffle(),repeat:e.getRepeat()}}),this.sendOutgoingEvent({type:"EVENT_VOLUME",payload:{volume:e.getVolume()}}),this.sendOutgoingEvent({type:"EVENT_TRACKS",payload:{count:e.getTracksList().length}}),this.getTheme();break}})}yandexExternalAPISubscribe(){e.on(e.EVENT_STATE,()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_STATE, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_STATE",payload:{isPlaying:e.isPlaying()}})}),e.on(e.EVENT_TRACK,()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_TRACK, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_TRACK",payload:{track:e.getCurrentTrack()}}),this.sendOutgoingEvent({type:"EVENT_PROGRESS",payload:{progress:e.getProgress()}})}),e.on(e.EVENT_CONTROLS,()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_CONTROLS, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_CONTROLS",payload:{states:e.getControls(),shuffle:e.getShuffle(),repeat:e.getRepeat()}}),this.sendOutgoingEvent({type:"EVENT_VOLUME",payload:{volume:e.getVolume()}}),this.sendOutgoingEvent({type:"EVENT_TRACK",payload:{notificationsIgnore:!0,track:e.getCurrentTrack()}})}),e.on(e.EVENT_TRACKS_LIST,()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_TRACKS_LIST, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_TRACKS",payload:{count:e.getTracksList().length}})});const t=r(()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_VOLUME, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_VOLUME",payload:{volume:e.getVolume()}})},500,{trailing:!0});e.on(e.EVENT_VOLUME,t.bind(this));const o=r(()=>{this.logger.debug("[yandexExternalAPISubscribe] Fired EVENT_PROGRESS, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_PROGRESS",payload:{progress:e.getProgress()}})},1e3);e.on(e.EVENT_PROGRESS,o.bind(this))}getTheme(){document.body.addEventListener("click",t=>{var o,g;if(((g=(o=t.target.parentNode)==null?void 0:o.previousSibling)==null?void 0:g.id)!=="darkTheme")return;const i=document.body.classList.contains("theme-black")?"dark":"light";this.logger.debug("[getTheme] Fired theme click, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_THEME",payload:{theme:i}})});const n=document.body.classList.contains("theme-black")?"dark":"light";this.logger.debug("[getTheme] Fired initial theme check, sending extension.outgoing.event"),this.sendOutgoingEvent({type:"EVENT_THEME",payload:{theme:n}})}}new u;
