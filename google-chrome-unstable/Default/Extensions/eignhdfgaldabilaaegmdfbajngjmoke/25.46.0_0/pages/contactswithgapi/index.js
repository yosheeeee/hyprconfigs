"use strict";!function(){var W=document,Y=browserStorage.sync.getItem("bm_pref__contacts__lastname");function K(e){return Array.isArray(e)&&0!==e.length?e:null}cjce.registerTemplate("bm-p-contactswithgapi",function(o,r){var s,l,d,m,u,i,e,p="https://contacts.google.com"+r.wizPath+"/",U="https://people.googleapis.com/v1/",x="https://www.google.com/m8/feeds/",t=["https://www.googleapis.com/auth/contacts.readonly"],c=40,a=window.devicePixelRatio||2,F=Math.ceil(c*a),h=p,b="home",_=null,D=25,R=["contactGroups/coworkers","contactGroups/family","contactGroups/friends"],f=!1,n=Y.then(function(e){f=Boolean(e)}),g="connections(resourceName,names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId),nextPageToken",j=null,y=!1,C=function(){if(cjgApis.info.getIsConsumerGmail(r.account))return Promise.resolve(!1);return cjgApis.cache.getItem(r.account,"bm_pref__contacts__directory").then(function(e){return"boolean"==typeof e?e:w().then(function(){return!0},function(){return!1}).then(function(e){return cjgApis.cache.setItem(r.account,"bm_pref__contacts__directory",e),e})})}().then(function(e){e&&(y=!0,g=g.replace("resourceName,","resourceName,metadata/sources(type,id),"))}),v=!1,N={};function q(){return cjgApis.info.getUserDomain(r.account).then(function(e){e=cjBasics.urlParams.attach(x+"gal/"+(e||"default")+"/full",{alt:"json","max-results":"50000"});return cjgApis.request(e,{fetchAs:"json",headers:{"GData-Version":"1.0"}},{account:r.account,requiredScopes:t})}).then(function(e){var i=[],e=e&&e.feed&&e.feed.entry;return Array.isArray(e)&&e.forEach(function(e){var a,n,t,c=function(e){if(!(e=e.id&&e.id.$t&&e.id.$t.split("full/P.")[1]))return null;for(var a=cjBasics.hex2dec(e);a.length<20;)a="0"+a;return a=a.length<21?"1"+a:a}(e);c&&(a=c="people/"+c,(e=(e=e).gd$name)&&(n=e.gd$fullName&&e.gd$fullName.$t,t=e.gd$givenName&&e.gd$givenName.$t,e=e.gd$familyName&&e.gd$familyName.$t,N[a]={displayName:n||t||e,displayNameLastFirst:e&&t?e+", "+t:null}),i.push(c))}),i})}function w(){return j=j||q()}function E(e){var a=function(e){var a=e.resourceName;if(y&&a.startsWith("people/c")){var n=e.metadata&&e.metadata.sources;if(Array.isArray(n))for(var t=0;t<n.length;t++)if("DOMAIN_PROFILE"===n[t].type)return"people/"+n[t].id}return a}(e),n=e&&e.names&&e.names[0]||N[a];if(n){var t,c=n.displayName||"",n=n.displayNameLastFirst||c;if(c)return t=[],Array.isArray(e.memberships)&&(t=e.memberships.map(function(e){return e.contactGroupMembership?e.contactGroupMembership.contactGroupId:"GSUITE_DIRECTORY_GROUP"})),{id:a,displayName:c,displayNameLastFirst:n,sortValue:c.toLowerCase(),sortValueLastFirst:n.toLowerCase(),photo:e.photos&&e.photos[0].url||null,memberships:t}}}function $(e){for(var a=[],n=[],t=0;t<e.length;t+=50){var c=L("people:batchGet",{resourceNames:e.splice(0,50),fields:"responses(requestedResourceName,person(names(displayName,displayNameLastFirst),photos/url,memberships/contactGroupMembership/contactGroupId))",personFields:"names,photos,memberships"}).then(function(e){e.responses.forEach(function(e){e.person.resourceName=e.requestedResourceName;e=E(e.person);e&&a.push(e)})});n.push(c)}return Promise.all(n).then(function(){return a})}function T(e,a){u.cjceSetLoading(!0),b=e,_=a,v&&P()}function S(e){var n=f?"sortValueLastFirst":"sortValue";e.sort(function(e,a){return e[n]<a[n]?-1:1})}function M(){Promise.all([cjgApis.cache.getItem(r.account,"bm_cache_v33__contacts__library"),n]).then(function(e){v||(s=e[0])&&(v=!0,P())}),Promise.all([C,n]).then(function(e){var a=function(e,a,n,t){var c=n||[];n="other"===e?"otherContacts":"people/me/connections";return L(n,{pageToken:t,pageSize:"2000",personFields:"memberships,metadata,names,photos",fields:g,sortOrder:a}).then(function(e){return Array.isArray(e.connections)&&(e.connections.forEach(function(e){e=E(e);e&&c.push(e)}),e.nextPageToken,0),c})}("main",f?"LAST_NAME_ASCENDING":"FIRST_NAME_ASCENDING");return y?Promise.all([w().then($),a]).then(function(e){var a=e[0],e=e[1],n=a.map(function(e){return e.id});return e.forEach(function(e){-1===n.indexOf(e.id)&&a.push(e)}),S(a),a}):a}).then(function(e){v=!0,s&&JSON.stringify(s).length===JSON.stringify(e).length||(cjgApis.cache.setItem(r.account,"bm_cache_v33__contacts__library",e),s=e,P())})}function L(a,n){var e=n||{},e=(e.prettyPrint="false",cjBasics.urlParams.attach(U+a,e));return cjgApis.request(e,{fetchAs:"json"},{account:r.account,requiredScopes:t}).catch(function(){return new Promise(function(e){setTimeout(function(){L(a,n).then(e)},4e3)})})}function A(){return cjce.createElement("ccbm-fabgroup",{items:[cjce.createElement("gmd-fab",{label:cjBasics.lang.i18n("cj_i18n_01285","Create contact"),onClick:function(){r.openTab(p+"new")}})]})}function B(e,a,n){return"string"!=typeof e?"/images/avatar.svg":((e=e.startsWith("http://")?e.replace("http://","https://"):e).startsWith("https://www.google.com/s2/")&&(e=e.replace("www","profiles")),cjgFrontend.urls.getAvatar(e,a,n))}function I(e,a){e=p+e.replace("people/","person/");a&&(e+="?edit=true"),r.openTab(e)}function G(a){return s.filter(function(e){return-1!==e.memberships.indexOf(a)})}function k(e,a){var t=W.createDocumentFragment();a.forEach(function(e){a=e,e=f&&a.displayNameLastFirst||a.displayName,n={size:c},a.photo?(n.url=B(a.photo,0,F),n.avatar=!0):(n.withShell=!0,n.symbol=e[0]||"-"),(n=cjce.createElement("cjmd-item",{icon:n,label:e})).classList.add("bm-p-contactswithgapi-listitem"),n.cjceContactsData=a,(e=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){I(a.id,!0)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),n.appendChild(e),(e=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_01545","Open in a new tab"),iconName:"__mdi:open_in_new",onClick:function(){I(a.id)}})).classList.add("bm-p-contactswithgapi-listitem__tool"),n.appendChild(e);var a,n,e=n;t.appendChild(e)}),e.appendChild(t)}function P(){u.cjceSetLoading(!0);var n,a,t,e,c,i=cjce.createElement("cjmd-container",{scrollable:!0,fabPadding:!0,infiniteScroll:!0,shadow:"thinOnScroll"});"home"===b?(0<(e=G("starred")).length&&(c=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00004","Starred")}),i.appendChild(c),k(c=cjce.createElement("cjmd-list"),e),i.appendChild(c),e=cjce.createElement("cjmd-subheader",{color:!0,label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")}),i.appendChild(e)),n=G("myContacts")):"search"===b?(a=_,n=s.filter(function(e){return-1!==JSON.stringify(e).indexOf(a)})):"directory"===b?n=G("GSUITE_DIRECTORY_GROUP"):"other"===b?n=G("SPECIAL_OTHER"):"label"===b&&(n=G(_)),0<n.length?(t=cjce.createElement("cjmd-list"),function e(){var a=n.splice(0,D);k(t,a),0!==n.length&&setTimeout(function(){i.cjceSetInfiniteScroll(e)})}(),i.appendChild(t)):(c=b,e=cjce.createElement("cjmd-emptystate",{color:!0,label:cjBasics.lang.i18n("cj_i18n_01275","No contacts found"),subLabel:"search"===c?cjBasics.lang.i18n("cj_i18n_00116","Try a synonym or more general keyword"):null,iconName:"search"===c?"__mdi:search":"__mdi:contacts_product"}),i.appendChild(e)),d.textContent="",d.appendChild(i),u.cjceSetLoading(!1)}function V(e,a){var n=a.resourceName.replace("contactGroups/",""),t=a.formattedName,c=t,a=a.memberCount;0<a&&(c+=" ("+a+")"),e.push({id:n,iconName:"__mdi:label",label:c,navigatorLabel:t,newTabUrl:p+"label/"+n})}function z(){cjce.applyTemplate(m,"bm-loading");var t=[{id:"home",iconName:"__mdi:person",label:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),navigatorLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),newTabUrl:p},{iconName:"__mdi:history",label:cjBasics.lang.i18n("cj_i18n_01276","Frequently contacted"),newTabUrl:p+"frequent",external:!0},{iconName:"__mdi:archive",label:cjBasics.lang.i18n("cj_i18n_01278","Other contacts"),newTabUrl:p+"other",divider:!0}],c=[{iconName:"__mdi:assistant",label:cjBasics.lang.i18n("cj_i18n_01277","Duplicates"),newTabUrl:p+"suggestions",external:!0},{iconName:"__mdi:delete",label:cjBasics.lang.i18n("cj_i18n_00005","Trash"),newTabUrl:p+"trash",external:!0,divider:!0}],i=W.createElement("div"),e=(m.appendChild(i),L("contactGroups",{pageSize:"500",fields:"contactGroups(resourceName,groupType,formattedName,memberCount)"}));Promise.all([e,n,C]).then(function(e){var n=[],a=(y&&(t[0].divider=!1,t.push({id:"directory",label:cjBasics.lang.i18n("cj_i18n_01279","Directory"),iconName:"__mdi:business",newTabUrl:p+"directory",divider:!0})),e[0].contactGroups.forEach(function(e){var a;"USER_CONTACT_GROUP"===e.groupType?V(n,e):"contactGroups/myContacts"===e.resourceName?0<(a=e.memberCount)&&(t[0].label+=" ("+a+")"):-1!==R.indexOf(e.resourceName)&&0<e.memberCount&&V(n,e)}),0<n.length&&(t.push({header:!0,label:cjBasics.lang.i18n("cj_i18n_01280","Labels")}),n.sort(function(e,a){return e.label.toLowerCase()<a.label.toLowerCase()?-1:1}),n[n.length-1].divider=!0,t=t.concat(n)),t=t.concat(c),l=cjce.createElement("bm-navlist",{compact:!0,isSelector:!0,selectedId:"home",items:t,onChange:function(e,a){h=a.newTabUrl||p,"home"===e||"directory"===e||"other"===e?T(e):T("label",e),u.cjceSetPageLabel(a.navigatorLabel||a.label)},onNewTab:function(e,a){r.openTab(a.newTabUrl)}}),i.appendChild(l),cjce.createElement("bm-drawerdropdown",{iconName:"__mdi:cj_sort_by_alpha",label:cjBasics.lang.i18n("cj_i18n_01281","Sort"),selectedId:f?"last":"first",items:[{value:"last",label:cjBasics.lang.i18n("cj_i18n_01282","Sort by last name")},{value:"first",label:cjBasics.lang.i18n("cj_i18n_01283","Sort by first name")}],onChange:function(){var e;e="last"===a.cjceSelectedId,f=e,browserStorage.sync.setItem("bm_pref__contacts__lastname",f),v&&(S(s),P())}}));m.appendChild(a),m.cjceSetLoading(!1)})}function O(a){var e=cjce.createElement("cjmd-item"),n=cjce.createElement("ccbm-iconbutton",{iconName:"__mdi:content_copy",label:cjBasics.lang.i18n("cj_i18n_07125","Copy to clipboard"),onClick:function(e){cjBasics.copyToClipboard(a.value),i||(i=cjce.createElement("ccbm-snackbar",{label:cjBasics.lang.i18n("cj_i18n_07124","Copied to clipboard")}),o.appendChild(i)),i.cjceShow()}}),t=(a.onClick?e.addEventListener("click",function(e){e=e.target;e===n||n.contains(e)||a.onClick()}):e.classList.add("no-action"),cjce.createElement("cjmd-icon",{name:a.iconName})),t=(e.appendChild(t),W.createElement("div")),c=(t.className="cjmd-item__body",e.appendChild(t),W.createElement("div"));return c.className="cjmd-item__header",c.textContent=a.value,t.appendChild(c),a.subLabel&&(c=cjce.createElement("cjmd-secondarytext",{label:a.subLabel}),t.appendChild(c)),e.appendChild(n),e}function H(e){e=encodeURIComponent(e);r.openTab(p+"search/"+e)}function J(){var e=l.cjceSelectedId;"home"===e||"directory"===e||"other"===e?T(e):T("label",e)}u=cjce.createElement("bm-ogb",{loading:!0,drawer:!0,serviceIcon:"contacts",serviceLabel:cjBasics.lang.i18n("cj_i18n_00314","Contacts"),pageLabel:cjBasics.lang.i18n("cj_i18n_00291","Home"),searchbox:{color:!0,onClear:J,onInput:function(e){e?T("search",e):J()},onSubmit:function(){d.querySelector(".cjmd-item").click()},onMetaSubmit:H},bmApis:r,onNewTab:function(){"search"===b?H(_):r.openTab(h)}}),o.appendChild(u),m=u.cjceDrawerEl,a=u.cjceSearchboxEl,e=A(),o.appendChild(e),r.setOnPageDisplayHandler(a.select),(d=cjce.createElement("cjmd-container")).addEventListener("click",function(e){var a,n,c,t,i,e=e.target.cjceContactsData;e&&(a=e,(n=cjce.createElement("cjmd-container",{solid:!0})).classList.add("bm-p-contactswithgapi-details"),e=cjce.createElement("bm-ogb",{floating:!0,displayBack:!0,onBack:function(){n.remove()},bmApis:r,onNewTab:function(){I(a.id)}}),n.appendChild(e),t=cjce.createElement("ccbm-iconbutton",{label:cjBasics.lang.i18n("cj_i18n_06290","Edit contact"),iconName:"__mdi:edit",onClick:function(){I(a.id,!0)}}),e.cjceAppendChild(t),(c=W.createElement("div")).className="bm-p-contactswithgapi-details__top",n.appendChild(c),e=f&&a.displayNameLastFirst||a.displayName,t={size:80},a.photo?(t.url=B(a.photo,80),t.avatar=!0):(t.symbol=e[0]||"-",t.withShell=!0),(t=cjce.createElement("cjmd-icon",t)).classList.add("bm-p-contactswithgapi-details__photo"),c.appendChild(t),(t=cjce.createElement("cjmd-title",{label:e})).classList.add("bm-p-contactswithgapi-details__name"),c.appendChild(t),e=cjce.createElement("cjmd-container",{scrollable:!0,shadow:"thickOnScroll"}),n.appendChild(e),i=cjce.createElement("cjmd-list"),e.appendChild(i),L(a.id,{fields:"addresses,birthdays,emailAddresses,phoneNumbers"}).then(function(e){var n=W.createDocumentFragment(),a=K(e.emailAddresses),t=(a&&a.forEach(function(e){var a=O({iconName:"__mdi:email",value:e.value,subLabel:e.formattedType,onClick:function(){r.openTab("mailto:"+e.value)}});n.appendChild(a)}),K(e.phoneNumbers));t&&t.forEach(function(e){var a=O({iconName:"__mdi:call",value:e.value,subLabel:e.formattedType,onClick:function(){r.openTab("tel:"+e.canonicalForm)}});n.appendChild(a)}),a&&(t=a[0].value,a=[{iconName:"__mdi:email",label:cjBasics.lang.i18n("cj_i18n_07233","Send email"),newTabUrl:"mailto:"+t},{iconName:"__mdi:event",label:cjBasics.lang.i18n("cj_i18n_07234","Schedule event"),newTabUrl:cjBasics.urlParams.attach("https://meet.google.com/new",{authuser:"0"===r.account.authuser?null:r.account.authuser,calleeId:t})},{iconName:"__mdi:meet",label:cjBasics.lang.i18n("cj_i18n_07235","Start video call"),newTabUrl:cjBasics.urlParams.attach("https://calendar.google.com/calendar/r/eventedit",{authuser:"0"===r.account.authuser?null:r.account.authuser,add:t})}],t=cjce.createElement("ccbm-biglinks",{bottom:!0,items:a,onClick:function(e,a){a=a.newTabUrl;r.openTab(a)}}),c.appendChild(t)),Array.isArray(e.addresses)&&0<e.addresses.length&&e.addresses.forEach(function(e){var a=O({iconName:"__mdi:place",value:e.formattedValue,subLabel:e.formattedType,onClick:function(){r.openTab(cjBasics.urlParams.attach("https://maps.google.com/",{authuser:"0"===r.account.authuser?null:r.account.authuser,q:e.formattedValue}))}});n.appendChild(a)}),Array.isArray(e.birthdays)&&0<e.birthdays.length&&e.birthdays.forEach(function(e){e=O({iconName:"__mdi:cake",value:e.text});n.appendChild(e)}),0===n.children.length&&((a=W.createElement("div")).className="bm-p-contactswithgapi-noinfo",a.textContent=cjBasics.lang.i18n("cj_i18n_01284","No more contact info found"),n.appendChild(a)),i.appendChild(n),u.cjceSetLoading(!1)}),o.appendChild(n))}),o.appendChild(d),M(),z(),cjgApis.auth.requireToken(r.account,t).catch(function(e){var a=cjce.createElement("bm-fulldialog",{bmApis:r,onNewTab:function(){r.openTab(h)},lockup:{label:cjBasics.lang.i18n("cj_i18n_00314","Contacts")},iconName:"contacts",message:cjBasics.lang.i18n("cj_i18n_01286","Before you can use this page, you need to give access to load your Google Contacts"),actionLabel:cjBasics.lang.i18n("cj_i18n_01916","Continue with Google"),actionG:!0,action:function(){cjgApis.auth.requestPermissions(r.account,e.cjg_missing_scopes)}}),n=A();a.appendChild(n),o.appendChild(a)})})}();